#!/usr/bin/env ruby

# David Selassie
# November 8, 2011
# csv2json

# Takes any number of CSV files, uses the first line as the headers for all files, then turns the whole shebang into a json array of objects and prints that to stdout.
# USAGE: csv2json CSVFILES...

require 'rubygems'
require 'trollop'

require 'json'

opts = Trollop::options do
    opt :delimiter, 'Delimiter', :default => ','
    opt :tab_separated, 'Set delimiter to tab'
end

if opts[:tab_separated] then
    delim = "\t"
else
    delim = opts[:delimiter]
end

fields = ARGF.readline.strip.sub(/^#*/, '').split(delim)

data = []
for line in ARGF
    data << fields.zip(line.strip.split(delim)).inject({}) do |struct, val|
        struct[val[0]] = val[1]
        struct
    end
end

puts data.to_json
